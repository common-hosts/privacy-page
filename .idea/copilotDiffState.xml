<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/googleSites.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/googleSites.py" />
              <option name="updatedContent" value="import argparse&#10;import html&#10;import re&#10;import subprocess&#10;from dataclasses import dataclass&#10;from pathlib import Path&#10;from typing import Optional&#10;&#10;&#10;REPO_ROOT = Path(__file__).resolve().parent&#10;INDEX_HTML_PATH = REPO_ROOT / &quot;index.html&quot;&#10;DEFAULT_COMMIT_MESSAGE = &quot;Update privacy page&quot;&#10;&#10;&#10;@dataclass&#10;class PageData:&#10;    title: str&#10;    # content can be plain text OR html fragment. use content_is_html to decide.&#10;    content: str&#10;    content_is_html: bool = False&#10;&#10;&#10;def run(cmd: list[str], cwd: Optional[Path] = None, check: bool = True) -&gt; subprocess.CompletedProcess:&#10;    return subprocess.run(cmd, cwd=str(cwd) if cwd else None, check=check, text=True, capture_output=True)&#10;&#10;&#10;def get_git_remote_url(remote: str = &quot;origin&quot;) -&gt; str:&#10;    try:&#10;        p = run([&quot;git&quot;, &quot;remote&quot;, &quot;get-url&quot;, remote], cwd=REPO_ROOT)&#10;        return (p.stdout or &quot;&quot;).strip()&#10;    except Exception:&#10;        return &quot;&quot;&#10;&#10;&#10;def get_repo_slug_from_remote(remote_url: str) -&gt; str:&#10;    &quot;&quot;&quot;Extract owner/repo from git remote (ssh or https).&quot;&quot;&quot;&#10;    # git@github.com:owner/repo.git&#10;    m = re.search(r&quot;github\.com[:/](?P&lt;slug&gt;[^/]+/[^/]+?)(?:\.git)?$&quot;, remote_url.strip())&#10;    if not m:&#10;        raise ValueError(f&quot;Unsupported remote url: {remote_url!r}&quot;)&#10;    return m.group(&quot;slug&quot;)&#10;&#10;&#10;def github_pages_expected_url(repo_slug: str) -&gt; str:&#10;    owner, repo = repo_slug.split(&quot;/&quot;, 1)&#10;    return f&quot;https://{owner}.github.io/{repo}/&quot;&#10;&#10;&#10;def escape_and_preserve_newlines_as_html(text: str) -&gt; str:&#10;    &quot;&quot;&quot;Plain text -&gt; safe HTML, keeping line breaks and indentation for nicer display.&quot;&quot;&quot;&#10;    safe = html.escape(text or &quot;&quot;)&#10;    # Keep leading spaces (indentation) by converting double spaces to &amp;nbsp;&amp;nbsp;&#10;    safe = safe.replace(&quot;  &quot;, &quot;&amp;nbsp;&amp;nbsp;&quot;)&#10;    # Convert newlines to &lt;br&gt;&#10;    safe = safe.replace(&quot;\r\n&quot;, &quot;\n&quot;).replace(&quot;\r&quot;, &quot;\n&quot;)&#10;    safe = safe.replace(&quot;\n&quot;, &quot;&lt;br&gt;\n&quot;)&#10;    return safe&#10;&#10;&#10;def render_index_html(template: str, page: PageData) -&gt; str:&#10;    if &quot;{title}&quot; not in template or &quot;{content}&quot; not in template:&#10;        raise ValueError(&quot;index.html template must contain {title} and {content} placeholders&quot;)&#10;&#10;    content_html = page.content if page.content_is_html else escape_and_preserve_newlines_as_html(page.content)&#10;&#10;    # Protect CSS braces in template: the provided template already uses body{{...}}.&#10;    return template.format(title=html.escape(page.title or &quot;&quot;), content=content_html)&#10;&#10;&#10;def update_index_html(page: PageData, index_path: Path = INDEX_HTML_PATH) -&gt; None:&#10;    template = index_path.read_text(encoding=&quot;utf-8&quot;)&#10;    rendered = render_index_html(template, page)&#10;    index_path.write_text(rendered, encoding=&quot;utf-8&quot;)&#10;&#10;&#10;def git_commit_push(commit_message: str = DEFAULT_COMMIT_MESSAGE) -&gt; None:&#10;    # stage&#10;    run([&quot;git&quot;, &quot;add&quot;, &quot;index.html&quot;], cwd=REPO_ROOT)&#10;&#10;    # commit (skip if no changes)&#10;    status = run([&quot;git&quot;, &quot;status&quot;, &quot;--porcelain&quot;], cwd=REPO_ROOT).stdout.strip()&#10;    if not status:&#10;        print(&quot;ℹ️ No git changes to commit.&quot;)&#10;        return&#10;&#10;    run([&quot;git&quot;, &quot;commit&quot;, &quot;-m&quot;, commit_message], cwd=REPO_ROOT)&#10;&#10;    # push current branch&#10;    branch = run([&quot;git&quot;, &quot;branch&quot;, &quot;--show-current&quot;], cwd=REPO_ROOT).stdout.strip() or &quot;main&quot;&#10;    run([&quot;git&quot;, &quot;push&quot;, &quot;origin&quot;, branch], cwd=REPO_ROOT)&#10;&#10;&#10;def read_content_from_file(path: Path) -&gt; str:&#10;    return path.read_text(encoding=&quot;utf-8&quot;)&#10;&#10;&#10;def main():&#10;    parser = argparse.ArgumentParser(description=&quot;Publish privacy page to GitHub Pages by updating index.html and pushing.&quot;)&#10;    parser.add_argument(&quot;--title&quot;, required=True, help=&quot;Page title&quot;)&#10;    parser.add_argument(&quot;--content&quot;, help=&quot;Page content (plain text).&quot;)&#10;    parser.add_argument(&quot;--content-file&quot;, help=&quot;Read content from a text file instead of --content&quot;)&#10;    parser.add_argument(&quot;--content-is-html&quot;, action=&quot;store_true&quot;, help=&quot;Treat content as HTML (no escaping).&quot;)&#10;    parser.add_argument(&quot;--commit-message&quot;, default=DEFAULT_COMMIT_MESSAGE, help=&quot;Git commit message&quot;)&#10;    parser.add_argument(&quot;--no-push&quot;, action=&quot;store_true&quot;, help=&quot;Only render index.html, do not commit/push&quot;)&#10;&#10;    args = parser.parse_args()&#10;&#10;    if bool(args.content) == bool(args.content_file):&#10;        raise SystemExit(&quot;Please provide exactly one of --content or --content-file&quot;)&#10;&#10;    content = args.content or read_content_from_file(Path(args.content_file).expanduser())&#10;&#10;    page = PageData(title=args.title, content=content, content_is_html=bool(args.content_is_html))&#10;    update_index_html(page)&#10;&#10;    print(&quot;✅ index.html updated.&quot;)&#10;&#10;    remote_url = get_git_remote_url(&quot;origin&quot;)&#10;    if remote_url:&#10;        repo_slug = get_repo_slug_from_remote(remote_url)&#10;        print(f&quot; Repo: {repo_slug}&quot;)&#10;        print(f&quot; Expected Pages URL (after enabling Pages): {github_pages_expected_url(repo_slug)}&quot;)&#10;&#10;    if args.no_push:&#10;        print(&quot;ℹ️ --no-push used. Skipping git commit/push.&quot;)&#10;        return&#10;&#10;    git_commit_push(args.commit_message)&#10;    print(&quot;✅ Committed and pushed.&quot;)&#10;&#10;    print(&quot;\nNext (one-time) step to enable GitHub Pages:&quot;)&#10;    print(&quot;1) Open your repo on GitHub -&gt; Settings -&gt; Pages&quot;)&#10;    print(&quot;2) Build and deployment -&gt; Source: Deploy from a branch&quot;)&#10;    print(&quot;3) Branch: main  /  Folder: / (root)&quot;)&#10;    print(&quot;4) Save, wait 1-2 minutes, then open the URL printed above.&quot;)&#10;&#10;&#10;if __name__ == &quot;__main__&quot;:&#10;    main()&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/index.html">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/index.html" />
              <option name="originalContent" value="&lt;html lang=&quot;zh-CN&quot;&gt;&#10;&lt;head&gt;&#10;  &lt;meta charset=&quot;utf-8&quot;&gt;&#10;  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1&quot;&gt;&#10;  &lt;title&gt;Test Title&lt;/title&gt;&#10;  &lt;style&gt;&#10;    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,&quot;Helvetica Neue&quot;,Arial;background:#f7f7fb;margin:0;padding:24px}&#10;    .container{max-width:860px;margin:28px auto;background:#fff;border-radius:10px;padding:28px;box-shadow:0 6px 22px rgba(20,20,30,0.06)}&#10;    h1{margin:0 0 12px;font-size:1.6rem}&#10;    .content{line-height:1.7;color:#222}&#10;  &lt;/style&gt;&#10;&lt;/head&gt;&#10;&lt;body&gt;&#10;  &lt;main class=&quot;container&quot;&gt;&#10;    &lt;h1&gt;Test Title&lt;/h1&gt;&#10;    &lt;div class=&quot;content&quot;&gt;&#10;Line1\n&amp;nbsp;&amp;nbsp;Indent\nLine3&#10;    &lt;/div&gt;&#10;  &lt;/main&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;" />
              <option name="updatedContent" value="&lt;html lang=&quot;zh-CN&quot;&gt;&#10;&lt;head&gt;&#10;  &lt;meta charset=&quot;utf-8&quot;&gt;&#10;  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1&quot;&gt;&#10;  &lt;title&gt;{title}&lt;/title&gt;&#10;  &lt;style&gt;&#10;    body{{font-family:system-ui,-apple-system,Segoe UI,Roboto,&quot;Helvetica Neue&quot;,Arial;background:#f7f7fb;margin:0;padding:24px}}&#10;    .container{{max-width:860px;margin:28px auto;background:#fff;border-radius:10px;padding:28px;box-shadow:0 6px 22px rgba(20,20,30,0.06)}}&#10;    h1{{margin:0 0 12px;font-size:1.6rem}}&#10;    .content{{line-height:1.7;color:#222}}&#10;  &lt;/style&gt;&#10;&lt;/head&gt;&#10;&lt;body&gt;&#10;  &lt;main class=&quot;container&quot;&gt;&#10;    &lt;h1&gt;{title}&lt;/h1&gt;&#10;    &lt;div class=&quot;content&quot;&gt;&#10;{content}&#10;    &lt;/div&gt;&#10;  &lt;/main&gt;&#10;&lt;/body&gt;&#10;&lt;/html&gt;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/privacy_merge.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/privacy_merge.py" />
              <option name="originalContent" value="import html&#10;import sys&#10;import urllib&#10;import subprocess&#10;&#10;import requests&#10;from selenium import webdriver&#10;import time&#10;from selenium.webdriver.common.by import By&#10;from bs4 import BeautifulSoup&#10;from selenium.webdriver.support.wait import WebDriverWait&#10;&#10;import base64&#10;import gzip&#10;import json&#10;import re&#10;from io import BytesIO&#10;from pathlib import Path&#10;from DrissionPage import Chromium&#10;&#10;PRIVACY_GEN_URL = &quot;https://app-privacy-policy-generator.firebaseapp.com/&quot;&#10;table_url = &quot;https://superxgr.larksuite.com/base/SebGbrq2yaNXXSsVOcJudpzxsCf?table=tblTywpT1yCgOaV7&amp;view=vewOnkM00z&quot;&#10;api_keyword = &quot;SebGbrq2yaNXXSsVOcJudpzxsCf/records&quot;&#10;browser = None&#10;browser_port = 9527&#10;cookies_str = &quot;&quot;&#10;app_name: str = &quot;&quot;&#10;company_name: str = &quot;&quot;&#10;email: str = &quot;&quot;&#10;&#10;&#10;def html_to_formatted_text(html_fragment: str) -&gt; str:&#10;    &quot;&quot;&quot;将 privacy_simple_content 的 innerHTML 转成较好粘贴的纯文本，保留段落、列表和链接结构。&quot;&quot;&quot;&#10;    if not html_fragment:&#10;        return &quot;&quot;&#10;    soup = BeautifulSoup(html_fragment, &quot;html.parser&quot;)&#10;&#10;    lines = []&#10;&#10;    from bs4.element import NavigableString, Tag&#10;&#10;    def handle_node(node, indent_level=0):&#10;        indent = &quot;  &quot; * indent_level&#10;&#10;        if isinstance(node, NavigableString):&#10;            text = str(node)&#10;            text = text.replace(&quot;\u200b&quot;, &quot;&quot;).strip(&quot;\n&quot;)&#10;            if text:&#10;                lines.append(indent + text)&#10;            return&#10;&#10;        if not isinstance(node, Tag):&#10;            return&#10;&#10;        name = (node.name or &quot;&quot;).lower()&#10;&#10;        if name == &quot;br&quot;:&#10;            lines.append(&quot;&quot;)&#10;            return&#10;&#10;        if name in {&quot;p&quot;, &quot;div&quot;, &quot;section&quot;, &quot;strong&quot;, &quot;b&quot;, &quot;em&quot;, &quot;i&quot;, &quot;h1&quot;, &quot;h2&quot;, &quot;h3&quot;, &quot;h4&quot;, &quot;h5&quot;, &quot;h6&quot;}:&#10;            before = len(lines)&#10;            for child in node.children:&#10;                handle_node(child, indent_level)&#10;            after = len(lines)&#10;            if after &gt; before and (not lines or lines[-1] != &quot;&quot;):&#10;                lines.append(&quot;&quot;)&#10;            return&#10;&#10;        if name in {&quot;ul&quot;, &quot;ol&quot;}:&#10;            if lines and lines[-1] != &quot;&quot;:&#10;                lines.append(&quot;&quot;)&#10;            idx = 1&#10;            for li in node.find_all(&quot;li&quot;, recursive=False):&#10;                prefix = &quot;- &quot; if name == &quot;ul&quot; else f&quot;{idx}. &quot;&#10;                buf = []&#10;&#10;                def collect(child):&#10;                    if isinstance(child, NavigableString):&#10;                        t = str(child).replace(&quot;\u200b&quot;, &quot;&quot;).strip(&quot;\n&quot;)&#10;                        if t:&#10;                            buf.append(t)&#10;                    elif isinstance(child, Tag):&#10;                        cname = (child.name or &quot;&quot;).lower()&#10;                        if cname == &quot;br&quot;:&#10;                            buf.append(&quot; &quot;)&#10;                        elif cname == &quot;a&quot;:&#10;                            href = child.get(&quot;href&quot;) or &quot;&quot;&#10;                            visible = child.get_text(strip=True)&#10;                            if href and visible:&#10;                                buf.append(f&quot;{visible} ({href})&quot;)&#10;                            else:&#10;                                buf.append(visible or href)&#10;                        else:&#10;                            for g in child.children:&#10;                                collect(g)&#10;&#10;                for c in li.children:&#10;                    collect(c)&#10;                li_text = &quot;&quot;.join(buf)&#10;                li_text = re.sub(r&quot;\s+&quot;, &quot; &quot;, li_text).strip()&#10;                if li_text:&#10;                    lines.append(indent + prefix + li_text)&#10;                for sub in li.find_all([&quot;ul&quot;, &quot;ol&quot;], recursive=False):&#10;                    handle_node(sub, indent_level + 1)&#10;                if lines and lines[-1] != &quot;&quot;:&#10;                    lines.append(&quot;&quot;)&#10;                idx += 1&#10;            return&#10;&#10;        if name == &quot;a&quot;:&#10;            href = node.get(&quot;href&quot;) or &quot;&quot;&#10;            visible = node.get_text(strip=True)&#10;            if href and visible:&#10;                lines.append(indent + f&quot;{visible} ({href})&quot;)&#10;            else:&#10;                lines.append(indent + (visible or href))&#10;            return&#10;&#10;        for child in node.children:&#10;            handle_node(child, indent_level)&#10;&#10;    root = soup.find(id=&quot;privacy_simple_content&quot;) or soup&#10;    for c in root.children:&#10;        handle_node(c, 0)&#10;&#10;    out = []&#10;    blank = 0&#10;    for ln in lines:&#10;        if ln.strip() == &quot;&quot;:&#10;            blank += 1&#10;            if blank &lt;= 2:&#10;                out.append(&quot;&quot;)&#10;        else:&#10;            blank = 0&#10;            out.append(ln)&#10;&#10;    text = &quot;\n&quot;.join(out)&#10;    text = text.replace(&quot;\r\n&quot;, &quot;\n&quot;)&#10;    text = re.sub(r&quot;\n{3,}&quot;, &quot;\n\n&quot;, text).strip()&#10;    return text&#10;&#10;&#10;def copy_to_clipboard_macos(text: str) -&gt; bool:&#10;    &quot;&quot;&quot;在 macOS 使用 pbcopy 复制文本到系统剪贴板。&quot;&quot;&quot;&#10;    if not text:&#10;        return False&#10;    try:&#10;        subprocess.run([&quot;pbcopy&quot;], input=text.encode(&quot;utf-8&quot;), check=True)&#10;        print(&quot;✅ 已复制到系统剪贴板 (pbcopy)&quot;)&#10;        return True&#10;    except Exception as e:&#10;        print(f&quot;⚠️ 复制到剪贴板失败: {e}&quot;)&#10;        return False&#10;&#10;&#10;def get_gzip_json_from_api(timeout: int = 60):&#10;    &quot;&quot;&quot;&#10;    1. 监听接口捕获动态参数。&#10;    2. 手动扫码登录，刷新页面触发接口。&#10;    3. 修改捕获到的 URL，设置 offset=0。&#10;    4. 提取 Cookies，使用 requests 库重新发送请求。&#10;    5. 解析响应，解压 Gzip 数据。&#10;    &quot;&quot;&quot;&#10;    global browser&#10;    if browser is None:&#10;        browser = Chromium(browser_port)&#10;&#10;    tab = browser.latest_tab&#10;    tab.get(table_url)&#10;    print(f&quot; 开始监听接口: {api_keyword}&quot;)&#10;    tab.listen.start(api_keyword)&#10;&#10;    input(&quot;请扫码登录并按 Enter 继续 &gt;&gt;&gt; &quot;)&#10;    tab.refresh()  # 触发接口请求&#10;&#10;    print(f&quot; 开始捕获接口请求...&quot;)&#10;    # 等待接口触发&#10;    req = tab.listen.wait(timeout=timeout)&#10;    tab.listen.stop()  # 捕获到后停止监听&#10;&#10;    if not req:&#10;        print(f&quot;❌ {timeout} 秒内未捕获到接口请求。&quot;)&#10;        return None&#10;&#10;    # --- 1. 获取原始 URL 并修改 offset ---&#10;    original_url = req.url&#10;    print(f&quot;✅ 捕获到原始接口: {original_url}&quot;)&#10;&#10;    # 解析 URL 和查询参数&#10;    parsed_url = urllib.parse.urlparse(original_url)&#10;    query_params = urllib.parse.parse_qs(parsed_url.query)&#10;&#10;    # 修改 offset 参数为 0（获取所有数据）&#10;    query_params[&quot;offset&quot;] = [&quot;0&quot;]&#10;&#10;    # 重新构建查询字符串和完整的 URL&#10;    new_query_string = urllib.parse.urlencode(query_params, doseq=True)&#10;    new_url = urllib.parse.urlunparse(parsed_url._replace(query=new_query_string))&#10;&#10;    print(f&quot; 正在用修改后的 URL (后台请求): {new_url}&quot;)&#10;&#10;    # --- 2. 提取已登录的 Cookies ---&#10;    current_cookies = tab.cookies()&#10;&#10;    # 将 cookies 转换为字符串形式，作为 HTTP 请求的头部&#10;    cookies_str = &quot;; &quot;.join(&#10;        [f&quot;{cookie['name']}={cookie['value']}&quot; for cookie in current_cookies]&#10;    )&#10;&#10;    # 设置 headers，带上 cookies&#10;    headers = {&quot;Cookie&quot;: cookies_str}&#10;&#10;    # --- 3. 使用 requests 发送请求 ---&#10;    try:&#10;        response = requests.get(new_url, headers=headers, timeout=timeout)&#10;    except requests.exceptions.RequestException as e:&#10;        print(f&quot;❌ 请求失败: {e}&quot;)&#10;        return None&#10;&#10;    # --- 4. 检查和提取响应体 ---&#10;&#10;    if response.status_code != 200:&#10;        print(f&quot;❌ 重新请求失败！HTTP 状态码: {response.status_code}&quot;)&#10;        return None&#10;&#10;    resp_body_text = response.text&#10;&#10;    if not resp_body_text:&#10;        print(f&quot;❌ 重新请求成功 (200)，但响应体为空。&quot;)&#10;        return None&#10;&#10;    # --- 5. 解析 JSON 和 Gzip 解压 ---&#10;&#10;    try:&#10;        resp_json = json.loads(resp_body_text)&#10;    except Exception as e:&#10;        print(f&quot;⚠️ 响应不是合法 JSON：{e}\n原始内容: {resp_body_text[:200]}&quot;)&#10;        return None&#10;&#10;    # 提取 gzip Base64 数据&#10;    try:&#10;        gzip_base64_str = resp_json[&quot;data&quot;][&quot;records&quot;]&#10;    except KeyError:&#10;        print(&quot;❌ 未找到 data.records 字段，请检查返回结构。&quot;)&#10;        return None&#10;&#10;    try:&#10;        gzip_bytes = base64.b64decode(gzip_base64_str)&#10;        with gzip.GzipFile(fileobj=BytesIO(gzip_bytes)) as f:&#10;            decompressed_data = f.read().decode(&quot;utf-8&quot;)&#10;        records_json = json.loads(decompressed_data)&#10;    except Exception as e:&#10;        print(f&quot;❌ 解压或解析失败: {e}&quot;)&#10;        return None&#10;&#10;    print(&quot;✅ 成功解压 JSON 数据！&quot;)&#10;    return records_json, cookies_str&#10;&#10;&#10;try:&#10;    from selenium.webdriver.support import expected_conditions as EC&#10;except Exception:&#10;    EC = None&#10;&#10;&#10;def normalize_text(s):&#10;    if not s:&#10;        return &quot;&quot;&#10;    return s.replace('\u200b', '').strip()&#10;&#10;&#10;def ensure_check_checkbox(driver, checkbox_id, timeout=10):&#10;    &quot;&quot;&quot;&#10;    稳健选中 checkbox：滚动、点击 label 或 input，或后备设置 checked 并派发 change。&#10;    &quot;&quot;&quot;&#10;    end_time = time.time() + timeout&#10;    while time.time() &lt; end_time:&#10;        try:&#10;            input_el = WebDriverWait(driver, 1).until(&#10;                EC.presence_of_element_located((By.ID, checkbox_id))&#10;            )&#10;        except Exception:&#10;            driver.execute_script(&quot;window.scrollBy(0, 400);&quot;)&#10;            time.sleep(0.4)&#10;            continue&#10;&#10;        try:&#10;            label = driver.find_element(By.CSS_SELECTOR, f&quot;label[for=\&quot;{checkbox_id}\&quot;]&quot;)&#10;        except Exception:&#10;            label = None&#10;&#10;        target = label if label is not None else input_el&#10;        try:&#10;            driver.execute_script(&quot;arguments[0].scrollIntoView({block: 'center'});&quot;, target)&#10;            driver.execute_script(&quot;window.scrollBy(0, -80);&quot;)&#10;            time.sleep(0.25)&#10;        except Exception:&#10;            pass&#10;&#10;        clicked = False&#10;        if label:&#10;            try:&#10;                driver.execute_script(&quot;arguments[0].click();&quot;, label)&#10;                clicked = True&#10;            except Exception:&#10;                clicked = False&#10;&#10;        if not clicked:&#10;            try:&#10;                driver.execute_script(&quot;arguments[0].click();&quot;, input_el)&#10;                clicked = True&#10;            except Exception:&#10;                clicked = False&#10;&#10;        if not clicked:&#10;            try:&#10;                driver.execute_script(&#10;                    &quot;var el = document.getElementById(arguments[0]); if(el){ el.checked = true; el.dispatchEvent(new Event('change')); }&quot;,&#10;                    checkbox_id&#10;                )&#10;            except Exception:&#10;                pass&#10;&#10;        try:&#10;            is_checked = driver.execute_script(&#10;                &quot;var el = document.getElementById(arguments[0]); return !!(el &amp;&amp; el.checked);&quot;, checkbox_id)&#10;            if is_checked:&#10;                print(f&quot;✅ 已成功选中：{checkbox_id}&quot;)&#10;                return True&#10;        except Exception:&#10;            pass&#10;&#10;        time.sleep(0.4)&#10;&#10;    print(f&quot;❌ 无法选中 {checkbox_id}（超时）&quot;)&#10;    return False&#10;&#10;&#10;def click_next_footer(driver, timeout=5):&#10;    &quot;&quot;&quot;在页脚点击文本为 Next 的按钮&quot;&quot;&quot;&#10;    end = time.time() + timeout&#10;    while time.time() &lt; end:&#10;        buttons = driver.find_elements(By.CLASS_NAME, &quot;card-footer-item&quot;)&#10;        for btn in buttons:&#10;            try:&#10;                if btn.text.strip().lower() == &quot;next&quot;:&#10;                    btn.click()&#10;                    return True&#10;            except Exception:&#10;                continue&#10;        time.sleep(0.3)&#10;    return False&#10;&#10;&#10;# python&#10;def extract_and_show_privacy_text(driver, wait_seconds=12):&#10;    driver.switch_to.default_content()&#10;    try:&#10;        WebDriverWait(driver, wait_seconds).until(&#10;            EC.presence_of_element_located((By.CSS_SELECTOR, &quot;.modal.is-active #privacy_simple_content&quot;))&#10;        )&#10;    except Exception:&#10;        print(&quot;❌ 未检测到弹窗或 privacy_simple_content&quot;)&#10;        return None&#10;&#10;    # 直接获取元素的 innerHTML 而不是整页 HTML&#10;    try:&#10;        inner_html = driver.execute_script(&#10;            &quot;var el=document.getElementById('privacy_simple_content');return el?el.innerHTML:'';&quot;&#10;        )&#10;    except Exception as e:&#10;        print(f&quot;❌ 获取 innerHTML 失败: {e}&quot;)&#10;        return None&#10;&#10;    if not inner_html:&#10;        print(&quot;❌ privacy_simple_content.innerHTML 为空&quot;)&#10;        return None&#10;&#10;    text = html_to_formatted_text(inner_html)&#10;    if not text:&#10;        print(&quot;❌ 解析结果为空&quot;)&#10;        return None&#10;&#10;    # 尝试复制到系统剪贴板&#10;    copy_to_clipboard_macos(text)&#10;&#10;    driver.execute_script(&#10;        &quot;&quot;&quot;&#10;        (function(value){&#10;            let ta = document.getElementById('privacy_plain_textarea');&#10;            if(!ta){&#10;                ta = document.createElement('textarea');&#10;                ta.id = 'privacy_plain_textarea';&#10;                Object.assign(ta.style,{&#10;                    position:'fixed',right:'20px',top:'20px',width:'520px',height:'600px',&#10;                    whiteSpace:'pre-wrap',zIndex:2147483647,fontSize:'12px',padding:'8px',&#10;                    background:'#fff',border:'1px solid rgba(0,0,0,0.2)',boxShadow:'0 2px 8px rgba(0,0,0,0.15)',&#10;                    resize:'both'&#10;                });&#10;                ta.onclick=function(){this.select();};&#10;                document.body.appendChild(ta);&#10;            }&#10;            ta.value=value;&#10;            ta.style.display='block';&#10;            ta.focus();&#10;            ta.select();&#10;            let copied=false;&#10;            try{document.execCommand('copy');copied=true;}catch(e){console.warn('copy failed',e);}&#10;            if(copied){&#10;                let toast=document.getElementById('privacy_copy_toast');&#10;                if(!toast){&#10;                    toast=document.createElement('div');&#10;                    toast.id='privacy_copy_toast';&#10;                    Object.assign(toast.style,{&#10;                        position:'fixed',bottom:'30px',right:'30px',padding:'10px 18px',&#10;                        background:'rgba(0,0,0,0.8)',color:'#fff',borderRadius:'6px',&#10;                        fontSize:'14px',zIndex:2147483647,transition:'opacity 0.3s'&#10;                    });&#10;                    document.body.appendChild(toast);&#10;                }&#10;                toast.textContent='隐私文本已复制';&#10;                toast.style.opacity='1';&#10;                setTimeout(()=&gt;{toast.style.opacity='0';},2000);&#10;            }&#10;            console.log('PRIVACY_PLAIN_TEXT_START\\n'+value+'\\nPRIVACY_PLAIN_TEXT_END');&#10;        })(arguments[0]);&#10;        &quot;&quot;&quot;,&#10;        text,&#10;    )&#10;&#10;    print(&quot;------ Privacy Policy 文本开始 ------&quot;)&#10;    print(text)&#10;    print(&quot;------ Privacy Policy 文本结束 ------&quot;)&#10;    print(&quot;------ 已复制到系统剪贴板 (pbcopy) ------&quot;)&#10;    return text&#10;&#10;&#10;def run_privacy_flow(driver, target_os=&quot;Android&quot;):&#10;    &quot;&quot;&quot;&#10;    执行隐私生成流程（基于 app-privacy-policy-generator）。&#10;&#10;    :param driver: selenium WebDriver 实例&#10;    :param target_os: 目标 OS 字符串，例如 &quot;iOS&quot; / &quot;Android&quot;&#10;    &quot;&quot;&quot;&#10;    global app_name, company_name, email&#10;&#10;    # 防止把 WebDriver 或其它对象当成 target_os 传进来&#10;    if not isinstance(target_os, str):&#10;        real_type = type(target_os).__name__&#10;        print(f&quot;❌ target_os 类型错误，期望字符串，实际为: {real_type}&quot;)&#10;        # 尝试回退到默认值&#10;        target_os = &quot;Android&quot;&#10;&#10;    target_os = (target_os or &quot;&quot;).strip()&#10;    if not target_os:&#10;        print(&quot;❌ target_os 为空字符串，使用默认 'Android'&quot;)&#10;        target_os = &quot;Android&quot;&#10;&#10;    driver.get(PRIVACY_GEN_URL)&#10;    try:&#10;        WebDriverWait(driver, 15).until(&#10;            EC.element_to_be_clickable((By.CLASS_NAME, &quot;start-btn&quot;))&#10;        ).click()&#10;    except Exception:&#10;        pass&#10;&#10;    # 等待 appName 输入出现&#10;    WebDriverWait(driver, 15).until(&#10;        EC.presence_of_element_located((By.ID, &quot;appName&quot;))&#10;    )&#10;    driver.find_element(By.ID, &quot;appName&quot;).clear()&#10;    driver.find_element(By.ID, &quot;appName&quot;).send_keys(app_name or &quot;&quot;)&#10;    driver.find_element(By.ID, &quot;appContact&quot;).clear()&#10;    driver.find_element(By.ID, &quot;appContact&quot;).send_keys(email or &quot;&quot;)&#10;    time.sleep(0.2)&#10;    click_next_footer(driver)&#10;&#10;    # 继续点击 Next（可能需要多步）&#10;    time.sleep(0.2)&#10;    click_next_footer(driver)&#10;    time.sleep(0.2)&#10;&#10;    # 选择 Mobile OS&#10;    radios = driver.find_elements(By.CSS_SELECTOR, 'input[type=&quot;radio&quot;]')&#10;    chosen = False&#10;    for r in radios:&#10;        try:&#10;            val = (r.get_attribute(&quot;value&quot;) or &quot;&quot;).strip()&#10;            if val and val.lower() == target_os.lower():&#10;                driver.execute_script(&#10;                    &quot;arguments[0].scrollIntoView({block:'center'});&quot;, r&#10;                )&#10;                r.click()&#10;                chosen = True&#10;                print(f&quot;✅ 已选择 Mobile OS: {target_os}&quot;)&#10;                break&#10;        except Exception:&#10;            continue&#10;    if not chosen:&#10;        # 打印页面里实际可用的 value，方便排查&#10;        available = []&#10;        for r in radios:&#10;            try:&#10;                v = (r.get_attribute(&quot;value&quot;) or &quot;&quot;).strip()&#10;                if v:&#10;                    available.append(v)&#10;            except Exception:&#10;                continue&#10;        print(&#10;            f&quot;❌ 没有找到 OS 选项: {target_os}，页面可用选项: {available or '[]'}&quot;&#10;        )&#10;&#10;    time.sleep(0.2)&#10;    click_next_footer(driver)&#10;    time.sleep(0.2)&#10;&#10;    # 填写 Company Name&#10;    dev_input = driver.find_elements(By.ID, &quot;devName&quot;)&#10;    if dev_input:&#10;        el = dev_input[0]&#10;        el.clear()&#10;        el.send_keys(company_name or &quot;&quot;)&#10;        print(&quot;✅ 已填写 Company Name&quot;)&#10;    time.sleep(0.2)&#10;    click_next_footer(driver)&#10;    time.sleep(0.2)&#10;&#10;    # 勾选第三方服务（示例 id 列表，可以根据页面实际 id 调整）&#10;    third_party_ids = [&#10;        &quot;list-switch-Google Analytics for Firebase&quot;,&#10;        &quot;list-switch-Firebase Crashlytics&quot;,&#10;        &quot;list-switch-Adjust&quot;,&#10;    ]&#10;    for cid in third_party_ids:&#10;        ensure_check_checkbox(driver, cid, timeout=6)&#10;        time.sleep(0.2)&#10;&#10;    # Next -&gt; Privacy Policy&#10;    time.sleep(0.2)&#10;    click_next_footer(driver)&#10;    time.sleep(0.2)&#10;&#10;    # 点击 Privacy Policy 按钮&#10;    footer_links = driver.find_elements(By.CLASS_NAME, &quot;card-footer-item&quot;)&#10;    clicked_priv = False&#10;    for link in footer_links:&#10;        try:&#10;            if link.text.strip().lower() == &quot;privacy policy&quot;:&#10;                link.click()&#10;                clicked_priv = True&#10;                print(&quot;✅ 已点击 Privacy Policy&quot;)&#10;                break&#10;        except Exception:&#10;            continue&#10;    if not clicked_priv:&#10;        print(&quot;❌ 没有找到 Privacy Policy 按钮&quot;)&#10;    extract_and_show_privacy_text(driver)&#10;    # return True&#10;&#10;&#10;# def create_driver(headless=False, user_data_dir=None, profile_dir=None):&#10;#     opts = webdriver.ChromeOptions()&#10;#     opts.add_argument('--start-maximized')&#10;#     if headless:&#10;#         opts.add_argument('--headless=new')&#10;#     if user_data_dir:&#10;#         opts.add_argument(f'--user-data-dir={user_data_dir}')&#10;#     if profile_dir:&#10;#         opts.add_argument(f'--profile-directory={profile_dir}')&#10;#     return webdriver.Chrome(options=opts)&#10;&#10;from selenium import webdriver&#10;from selenium.webdriver.chrome.service import Service&#10;from webdriver_manager.chrome import ChromeDriverManager&#10;&#10;def create_driver(headless=False, user_data_dir=None, profile_dir=None, chrome_binary=None):&#10;    opts = webdriver.ChromeOptions()&#10;    opts.add_argument('--start-maximized')&#10;    if headless:&#10;        opts.add_argument('--headless=new')&#10;    if user_data_dir:&#10;        opts.add_argument(f'--user-data-dir={user_data_dir}')&#10;    if profile_dir:&#10;        opts.add_argument(f'--profile-directory={profile_dir}')&#10;    if chrome_binary:&#10;        opts.binary_location = chrome_binary  # 可选：显式指定 Chrome 可执行文件路径&#10;    service = Service(ChromeDriverManager().install())  # 自动下载并使用匹配的 chromedriver&#10;    return webdriver.Chrome(service=service, options=opts)&#10;&#10;&#10;def find_and_collect_by_target_value(json_obj, target_value=None):&#10;    &quot;&quot;&quot;&#10;    按订单号筛选并在找到时把 app_name 写入全局变量 app_name，继续返回结果列表。&#10;    &quot;&quot;&quot;&#10;    # 顶层函数本身不直接读写 app_name，只在内部嵌套函数里操作&#10;&#10;    if not target_value:&#10;        print(&quot;❌ 需要提供 target_value (订单编号)，例如 'IGT1185'&quot;)&#10;        return []&#10;&#10;    results = []&#10;    target_str = str(target_value).strip().lower()&#10;&#10;    def _search(obj):&#10;        # 这里显式声明使用全局 app_name，避免 UnboundLocalError&#10;        global app_name&#10;&#10;        if isinstance(obj, dict):&#10;            fld_order = obj.get(&quot;fldxQWjXD7&quot;)&#10;            if isinstance(fld_order, dict):&#10;                val = fld_order.get(&quot;value&quot;)&#10;                if isinstance(val, list):&#10;                    for entry in val:&#10;                        if isinstance(entry, dict):&#10;                            text = (entry.get(&quot;text&quot;) or &quot;&quot;).strip()&#10;                            if text.lower() == target_str:&#10;                                # 提取 app_name（来自 fldaShB3Gb 的第一个 value 的 text）&#10;                                found_app_name = None&#10;                                flda = obj.get(&quot;fldaShB3Gb&quot;)&#10;                                if isinstance(flda, dict):&#10;                                    fval = flda.get(&quot;value&quot;)&#10;                                    if isinstance(fval, list) and fval:&#10;                                        first = fval[0]&#10;                                        if isinstance(first, dict):&#10;                                            found_app_name = (first.get(&quot;text&quot;) or &quot;&quot;).strip() or None&#10;&#10;                                # 尝试在 fldnLglcRi 中写入 app_name 并返回其第一个 value&#10;                                fldn = obj.get(&quot;fldnLglcRi&quot;)&#10;                                if isinstance(fldn, dict):&#10;                                    v = fldn.get(&quot;value&quot;)&#10;                                    if isinstance(v, list) and v:&#10;                                        first_item = v[0]&#10;                                        if isinstance(first_item, dict):&#10;                                            if found_app_name:&#10;                                                first_item[&quot;app_name&quot;] = found_app_name&#10;                                            results.append(first_item)&#10;                                        else:&#10;                                            new_item = {&quot;value&quot;: first_item}&#10;                                            if found_app_name:&#10;                                                new_item[&quot;app_name&quot;] = found_app_name&#10;                                            results.append(new_item)&#10;                                    else:&#10;                                        new_item = {}&#10;                                        if found_app_name:&#10;                                            new_item[&quot;app_name&quot;] = found_app_name&#10;                                        results.append(new_item)&#10;                                else:&#10;                                    if found_app_name:&#10;                                        results.append({&quot;app_name&quot;: found_app_name})&#10;                                    else:&#10;                                        results.append(obj)&#10;&#10;                                # 无论之前是否有值，直接把找到的 app_name 赋给全局变量&#10;                                if found_app_name:&#10;                                    app_name = found_app_name&#10;                                    print(f&quot; 已设置全局 app_name = `{app_name}`&quot;)&#10;&#10;                                break&#10;&#10;            # 继续递归查找子节点&#10;            for v in obj.values():&#10;                _search(v)&#10;&#10;        elif isinstance(obj, list):&#10;            for item in obj:&#10;                _search(item)&#10;&#10;    _search(json_obj)&#10;    return results&#10;&#10;&#10;def extract_vps_array_from_doc22(doc_data, cookies_str):&#10;    global company_name, email&#10;    print(&quot; 提取页面中首个有效的 @gmail.com 邮箱...&quot;)&#10;    results = []&#10;    seen_urls = set()&#10;&#10;    headers = {&#10;        &quot;Cookie&quot;: cookies_str or &quot;&quot;,&#10;        &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/123.0 Safari/537.36&quot;,&#10;    }&#10;&#10;    email_re = re.compile(r'(?&lt;![A-Za-z0-9._%+\-])([A-Za-z0-9._%+\-]+@gmail\.com)\b', re.I)&#10;&#10;    def _clean_gmail_emails(raw_text):&#10;        found = email_re.findall(raw_text or &quot;&quot;)&#10;        unique = []&#10;        seen = set()&#10;        for e in found:&#10;            ne = e.strip().lower()&#10;            if ne and ne not in seen:&#10;                seen.add(ne)&#10;                unique.append(ne)&#10;        final = []&#10;        sset = set(unique)&#10;        for e in unique:&#10;            if len(e) &gt; 1 and e[1:] in sset and len(e[0]) == 1:&#10;                continue&#10;            final.append(e)&#10;        return final&#10;&#10;    for item in doc_data:&#10;        url = item.get(&quot;link&quot;)&#10;        text = item.get(&quot;text&quot;, &quot;&quot;)&#10;        if not url and not text:&#10;            continue&#10;        if url in seen_urls:&#10;            continue&#10;&#10;        try:&#10;            response = requests.get(url, headers=headers, timeout=15)&#10;            if response.status_code != 200:&#10;                print(f&quot;❌ 请求失败: {url}, 状态码: {response.status_code}&quot;)&#10;                continue&#10;&#10;            page_content = html.unescape(response.text or &quot;&quot;)&#10;            emails = _clean_gmail_emails(page_content)&#10;            primary = emails[0] if emails else &quot;&quot;&#10;&#10;            # 首次发现时，设置全局 company_name 和 email（如果尚未设置）&#10;            if not company_name:&#10;                t = (text or &quot;&quot;).strip()&#10;                m = re.search(r'-(.+)$', t)&#10;                if m:&#10;                    company_name = m.group(1).strip()&#10;                else:&#10;                    parts = t.split(None, 1)&#10;                    company_name = parts[1].strip() if len(parts) &gt; 1 else (t or &quot;&quot;)&#10;&#10;            if primary and not email:&#10;                email = primary.strip().lower()&#10;&#10;            results.append(&#10;                {&#10;                    &quot;text&quot;: text,&#10;                    &quot;url&quot;: url,&#10;                    &quot;email&quot;: primary,&#10;                }&#10;            )&#10;            seen_urls.add(url)&#10;&#10;        except Exception as e:&#10;            print(f&quot;❌ 解析失败: {url}, 错误: {e}&quot;)&#10;&#10;        # 如果全局信息都已填充，可以选择提前退出以加快速度&#10;        if company_name and email:&#10;            break&#10;&#10;    # 按 text 中的数字排序（保持原有行为）&#10;    def _extract_number(t):&#10;        m = re.search(r&quot;(\d+)&quot;, (t or &quot;&quot;))&#10;        return int(m.group(1)) if m else 0&#10;&#10;    results.sort(key=lambda x: _extract_number(x.get(&quot;text&quot;)))&#10;&#10;    for item in results:&#10;        print(f&quot;{item.get('text')}&quot;)&#10;        if item.get('email'):&#10;            print(f&quot;  邮箱: {item.get('email')}&quot;)&#10;        else:&#10;            print(&quot;  邮箱: 未发现 @gmail.com 地址&quot;)&#10;        print(&quot;-&quot; * 50)&#10;&#10;    print(f&quot;✅ 总数量: {len(results)}&quot;)&#10;    return results&#10;&#10;&#10;def save_to_json(data, filename=&quot;none.json&quot;):&#10;    Path(filename).write_text(json.dumps(data, ensure_ascii=False, indent=2))&#10;    # print(f&quot;✅ 已保存 {len(data)} 条结果到 {filename}&quot;)&#10;&#10;&#10;import argparse&#10;&#10;if __name__ == &quot;__main__&quot;:&#10;    parser = argparse.ArgumentParser()&#10;    parser.add_argument('id', nargs='?', help='表格中查找的编号，例如 IGT1128')&#10;    args = parser.parse_args()&#10;&#10;    # 交互获取 id（若未通过命令行提供）&#10;    if not args.id:&#10;        try:&#10;            args.id = input(&quot;请输入编号（例如 IGT1128）：&quot;).strip()&#10;        except (EOFError, KeyboardInterrupt):&#10;            args.id = None&#10;&#10;    if not args.id:&#10;        print(&quot;❌ 未提供编号，脚本将退出。\n示例用法：python privacys.py IGT1128 --scan&quot;)&#10;        sys.exit(2)&#10;&#10;    try:&#10;        records, cookies_str = get_gzip_json_from_api()&#10;        if not records:&#10;            print(&quot;❌ 未能获取 records，脚本退出&quot;)&#10;            sys.exit(1)&#10;&#10;        # save_to_json(records, &quot;records_complete.json&quot;)&#10;        available_records = find_and_collect_by_target_value(records, target_value=args.id)&#10;        # save_to_json(available_records, &quot;state_filtered.json&quot;)&#10;&#10;        vps_result = extract_vps_array_from_doc22(available_records, cookies_str)&#10;        # save_to_json(vps_result, &quot;vps_result.json&quot;)&#10;        driver = create_driver()&#10;        run_privacy_flow(driver=driver, target_os=&quot;Android&quot;)&#10;    finally:&#10;        if driver:&#10;           driver.quit()&#10;" />
              <option name="updatedContent" value="import html&#10;import sys&#10;import urllib&#10;import subprocess&#10;&#10;import requests&#10;from selenium import webdriver&#10;import time&#10;from selenium.webdriver.common.by import By&#10;from bs4 import BeautifulSoup&#10;from selenium.webdriver.support.wait import WebDriverWait&#10;&#10;import base64&#10;import gzip&#10;import json&#10;import re&#10;from io import BytesIO&#10;from pathlib import Path&#10;from DrissionPage import Chromium&#10;&#10;PRIVACY_GEN_URL = &quot;https://app-privacy-policy-generator.firebaseapp.com/&quot;&#10;table_url = &quot;https://superxgr.larksuite.com/base/SebGbrq2yaNXXSsVOcJudpzxsCf?table=tblTywpT1yCgOaV7&amp;view=vewOnkM00z&quot;&#10;api_keyword = &quot;SebGbrq2yaNXXSsVOcJudpzxsCf/records&quot;&#10;browser = None&#10;browser_port = 9527&#10;cookies_str = &quot;&quot;&#10;app_name: str = &quot;&quot;&#10;company_name: str = &quot;&quot;&#10;email: str = &quot;&quot;&#10;&#10;# 用于 finally 安全退出&#10;driver = None&#10;&#10;# 生成并发布静态页需要的输出文件&#10;PRIVACY_TEXT_OUT = Path(__file__).resolve().parent / &quot;privacy_text.txt&quot;&#10;&#10;&#10;def html_to_formatted_text(html_fragment: str) -&gt; str:&#10;    &quot;&quot;&quot;将 privacy_simple_content 的 innerHTML 转成较好粘贴的纯文本，保留段落、列表和链接结构。&quot;&quot;&quot;&#10;    if not html_fragment:&#10;        return &quot;&quot;&#10;    soup = BeautifulSoup(html_fragment, &quot;html.parser&quot;)&#10;&#10;    lines = []&#10;&#10;    from bs4.element import NavigableString, Tag&#10;&#10;    def handle_node(node, indent_level=0):&#10;        indent = &quot;  &quot; * indent_level&#10;&#10;        if isinstance(node, NavigableString):&#10;            text = str(node)&#10;            text = text.replace(&quot;\u200b&quot;, &quot;&quot;).strip(&quot;\n&quot;)&#10;            if text:&#10;                lines.append(indent + text)&#10;            return&#10;&#10;        if not isinstance(node, Tag):&#10;            return&#10;&#10;        name = (node.name or &quot;&quot;).lower()&#10;&#10;        if name == &quot;br&quot;:&#10;            lines.append(&quot;&quot;)&#10;            return&#10;&#10;        if name in {&quot;p&quot;, &quot;div&quot;, &quot;section&quot;, &quot;strong&quot;, &quot;b&quot;, &quot;em&quot;, &quot;i&quot;, &quot;h1&quot;, &quot;h2&quot;, &quot;h3&quot;, &quot;h4&quot;, &quot;h5&quot;, &quot;h6&quot;}:&#10;            before = len(lines)&#10;            for child in node.children:&#10;                handle_node(child, indent_level)&#10;            after = len(lines)&#10;            if after &gt; before and (not lines or lines[-1] != &quot;&quot;):&#10;                lines.append(&quot;&quot;)&#10;            return&#10;&#10;        if name in {&quot;ul&quot;, &quot;ol&quot;}:&#10;            if lines and lines[-1] != &quot;&quot;:&#10;                lines.append(&quot;&quot;)&#10;            idx = 1&#10;            for li in node.find_all(&quot;li&quot;, recursive=False):&#10;                prefix = &quot;- &quot; if name == &quot;ul&quot; else f&quot;{idx}. &quot;&#10;                buf = []&#10;&#10;                def collect(child):&#10;                    if isinstance(child, NavigableString):&#10;                        t = str(child).replace(&quot;\u200b&quot;, &quot;&quot;).strip(&quot;\n&quot;)&#10;                        if t:&#10;                            buf.append(t)&#10;                    elif isinstance(child, Tag):&#10;                        cname = (child.name or &quot;&quot;).lower()&#10;                        if cname == &quot;br&quot;:&#10;                            buf.append(&quot; &quot;)&#10;                        elif cname == &quot;a&quot;:&#10;                            href = child.get(&quot;href&quot;) or &quot;&quot;&#10;                            visible = child.get_text(strip=True)&#10;                            if href and visible:&#10;                                buf.append(f&quot;{visible} ({href})&quot;)&#10;                            else:&#10;                                buf.append(visible or href)&#10;                        else:&#10;                            for g in child.children:&#10;                                collect(g)&#10;&#10;                for c in li.children:&#10;                    collect(c)&#10;                li_text = &quot;&quot;.join(buf)&#10;                li_text = re.sub(r&quot;\s+&quot;, &quot; &quot;, li_text).strip()&#10;                if li_text:&#10;                    lines.append(indent + prefix + li_text)&#10;                for sub in li.find_all([&quot;ul&quot;, &quot;ol&quot;], recursive=False):&#10;                    handle_node(sub, indent_level + 1)&#10;                if lines and lines[-1] != &quot;&quot;:&#10;                    lines.append(&quot;&quot;)&#10;                idx += 1&#10;            return&#10;&#10;        if name == &quot;a&quot;:&#10;            href = node.get(&quot;href&quot;) or &quot;&quot;&#10;            visible = node.get_text(strip=True)&#10;            if href and visible:&#10;                lines.append(indent + f&quot;{visible} ({href})&quot;)&#10;            else:&#10;                lines.append(indent + (visible or href))&#10;            return&#10;&#10;        for child in node.children:&#10;            handle_node(child, indent_level)&#10;&#10;    root = soup.find(id=&quot;privacy_simple_content&quot;) or soup&#10;    for c in root.children:&#10;        handle_node(c, 0)&#10;&#10;    out = []&#10;    blank = 0&#10;    for ln in lines:&#10;        if ln.strip() == &quot;&quot;:&#10;            blank += 1&#10;            if blank &lt;= 2:&#10;                out.append(&quot;&quot;)&#10;        else:&#10;            blank = 0&#10;            out.append(ln)&#10;&#10;    text = &quot;\n&quot;.join(out)&#10;    text = text.replace(&quot;\r\n&quot;, &quot;\n&quot;)&#10;    text = re.sub(r&quot;\n{3,}&quot;, &quot;\n\n&quot;, text).strip()&#10;    return text&#10;&#10;&#10;def copy_to_clipboard_macos(text: str) -&gt; bool:&#10;    &quot;&quot;&quot;在 macOS 使用 pbcopy 复制文本到系统剪贴板。&quot;&quot;&quot;&#10;    if not text:&#10;        return False&#10;    try:&#10;        subprocess.run([&quot;pbcopy&quot;], input=text.encode(&quot;utf-8&quot;), check=True)&#10;        print(&quot;✅ 已复制到系统剪贴板 (pbcopy)&quot;)&#10;        return True&#10;    except Exception as e:&#10;        print(f&quot;⚠️ 复制到剪贴板失败: {e}&quot;)&#10;        return False&#10;&#10;&#10;def get_gzip_json_from_api(timeout: int = 60):&#10;    &quot;&quot;&quot;&#10;    1. 监听接口捕获动态参数。&#10;    2. 手动扫码登录，刷新页面触发接口。&#10;    3. 修改捕获到的 URL，设置 offset=0。&#10;    4. 提取 Cookies，使用 requests 库重新发送请求。&#10;    5. 解析响应，解压 Gzip 数据。&#10;    &quot;&quot;&quot;&#10;    global browser&#10;    if browser is None:&#10;        browser = Chromium(browser_port)&#10;&#10;    tab = browser.latest_tab&#10;    tab.get(table_url)&#10;    print(f&quot; 开始监听接口: {api_keyword}&quot;)&#10;    tab.listen.start(api_keyword)&#10;&#10;    input(&quot;请扫码登录并按 Enter 继续 &gt;&gt;&gt; &quot;)&#10;    tab.refresh()  # 触发接口请求&#10;&#10;    print(f&quot; 开始捕获接口请求...&quot;)&#10;    # 等待接口触发&#10;    req = tab.listen.wait(timeout=timeout)&#10;    tab.listen.stop()  # 捕获到后停止监听&#10;&#10;    if not req:&#10;        print(f&quot;❌ {timeout} 秒内未捕获到接口请求。&quot;)&#10;        return None&#10;&#10;    # --- 1. 获取原始 URL 并修改 offset ---&#10;    original_url = req.url&#10;    print(f&quot;✅ 捕获到原始接口: {original_url}&quot;)&#10;&#10;    # 解析 URL 和查询参数&#10;    parsed_url = urllib.parse.urlparse(original_url)&#10;    query_params = urllib.parse.parse_qs(parsed_url.query)&#10;&#10;    # 修改 offset 参数为 0（获取所有数据）&#10;    query_params[&quot;offset&quot;] = [&quot;0&quot;]&#10;&#10;    # 重新构建查询字符串和完整的 URL&#10;    new_query_string = urllib.parse.urlencode(query_params, doseq=True)&#10;    new_url = urllib.parse.urlunparse(parsed_url._replace(query=new_query_string))&#10;&#10;    print(f&quot; 正在用修改后的 URL (后台请求): {new_url}&quot;)&#10;&#10;    # --- 2. 提取已登录的 Cookies ---&#10;    current_cookies = tab.cookies()&#10;&#10;    # 将 cookies 转换为字符串形式，作为 HTTP 请求的头部&#10;    cookies_str = &quot;; &quot;.join(&#10;        [f&quot;{cookie['name']}={cookie['value']}&quot; for cookie in current_cookies]&#10;    )&#10;&#10;    # 设置 headers，带上 cookies&#10;    headers = {&quot;Cookie&quot;: cookies_str}&#10;&#10;    # --- 3. 使用 requests 发送请求 ---&#10;    try:&#10;        response = requests.get(new_url, headers=headers, timeout=timeout)&#10;    except requests.exceptions.RequestException as e:&#10;        print(f&quot;❌ 请求失败: {e}&quot;)&#10;        return None&#10;&#10;    # --- 4. 检查和提取响应体 ---&#10;&#10;    if response.status_code != 200:&#10;        print(f&quot;❌ 重新请求失败！HTTP 状态码: {response.status_code}&quot;)&#10;        return None&#10;&#10;    resp_body_text = response.text&#10;&#10;    if not resp_body_text:&#10;        print(f&quot;❌ 重新请求成功 (200)，但响应体为空。&quot;)&#10;        return None&#10;&#10;    # --- 5. 解析 JSON 和 Gzip 解压 ---&#10;&#10;    try:&#10;        resp_json = json.loads(resp_body_text)&#10;    except Exception as e:&#10;        print(f&quot;⚠️ 响应不是合法 JSON：{e}\n原始内容: {resp_body_text[:200]}&quot;)&#10;        return None&#10;&#10;    # 提取 gzip Base64 数据&#10;    try:&#10;        gzip_base64_str = resp_json[&quot;data&quot;][&quot;records&quot;]&#10;    except KeyError:&#10;        print(&quot;❌ 未找到 data.records 字段，请检查返回结构。&quot;)&#10;        return None&#10;&#10;    try:&#10;        gzip_bytes = base64.b64decode(gzip_base64_str)&#10;        with gzip.GzipFile(fileobj=BytesIO(gzip_bytes)) as f:&#10;            decompressed_data = f.read().decode(&quot;utf-8&quot;)&#10;        records_json = json.loads(decompressed_data)&#10;    except Exception as e:&#10;        print(f&quot;❌ 解压或解析失败: {e}&quot;)&#10;        return None&#10;&#10;    print(&quot;✅ 成功解压 JSON 数据！&quot;)&#10;    return records_json, cookies_str&#10;&#10;&#10;try:&#10;    from selenium.webdriver.support import expected_conditions as EC&#10;except Exception:&#10;    EC = None&#10;&#10;&#10;def normalize_text(s):&#10;    if not s:&#10;        return &quot;&quot;&#10;    return s.replace('\u200b', '').strip()&#10;&#10;&#10;def ensure_check_checkbox(driver, checkbox_id, timeout=10):&#10;    &quot;&quot;&quot;&#10;    稳健选中 checkbox：滚动、点击 label 或 input，或后备设置 checked 并派发 change。&#10;    &quot;&quot;&quot;&#10;    end_time = time.time() + timeout&#10;    while time.time() &lt; end_time:&#10;        try:&#10;            input_el = WebDriverWait(driver, 1).until(&#10;                EC.presence_of_element_located((By.ID, checkbox_id))&#10;            )&#10;        except Exception:&#10;            driver.execute_script(&quot;window.scrollBy(0, 400);&quot;)&#10;            time.sleep(0.4)&#10;            continue&#10;&#10;        try:&#10;            label = driver.find_element(By.CSS_SELECTOR, f&quot;label[for=\&quot;{checkbox_id}\&quot;]&quot;)&#10;        except Exception:&#10;            label = None&#10;&#10;        target = label if label is not None else input_el&#10;        try:&#10;            driver.execute_script(&quot;arguments[0].scrollIntoView({block: 'center'});&quot;, target)&#10;            driver.execute_script(&quot;window.scrollBy(0, -80);&quot;)&#10;            time.sleep(0.25)&#10;        except Exception:&#10;            pass&#10;&#10;        clicked = False&#10;        if label:&#10;            try:&#10;                driver.execute_script(&quot;arguments[0].click();&quot;, label)&#10;                clicked = True&#10;            except Exception:&#10;                clicked = False&#10;&#10;        if not clicked:&#10;            try:&#10;                driver.execute_script(&quot;arguments[0].click();&quot;, input_el)&#10;                clicked = True&#10;            except Exception:&#10;                clicked = False&#10;&#10;        if not clicked:&#10;            try:&#10;                driver.execute_script(&#10;                    &quot;var el = document.getElementById(arguments[0]); if(el){ el.checked = true; el.dispatchEvent(new Event('change')); }&quot;,&#10;                    checkbox_id&#10;                )&#10;            except Exception:&#10;                pass&#10;&#10;        try:&#10;            is_checked = driver.execute_script(&#10;                &quot;var el = document.getElementById(arguments[0]); return !!(el &amp;&amp; el.checked);&quot;, checkbox_id)&#10;            if is_checked:&#10;                print(f&quot;✅ 已成功选中：{checkbox_id}&quot;)&#10;                return True&#10;        except Exception:&#10;            pass&#10;&#10;        time.sleep(0.4)&#10;&#10;    print(f&quot;❌ 无法选中 {checkbox_id}（超时）&quot;)&#10;    return False&#10;&#10;&#10;def click_next_footer(driver, timeout=5):&#10;    &quot;&quot;&quot;在页脚点击文本为 Next 的按钮&quot;&quot;&quot;&#10;    end = time.time() + timeout&#10;    while time.time() &lt; end:&#10;        buttons = driver.find_elements(By.CLASS_NAME, &quot;card-footer-item&quot;)&#10;        for btn in buttons:&#10;            try:&#10;                if btn.text.strip().lower() == &quot;next&quot;:&#10;                    btn.click()&#10;                    return True&#10;            except Exception:&#10;                continue&#10;        time.sleep(0.3)&#10;    return False&#10;&#10;&#10;# python&#10;def extract_and_show_privacy_text(driver, wait_seconds=12):&#10;    driver.switch_to.default_content()&#10;    try:&#10;        WebDriverWait(driver, wait_seconds).until(&#10;            EC.presence_of_element_located((By.CSS_SELECTOR, &quot;.modal.is-active #privacy_simple_content&quot;))&#10;        )&#10;    except Exception:&#10;        print(&quot;❌ 未检测到弹窗或 privacy_simple_content&quot;)&#10;        return None&#10;&#10;    # 直接获取元素的 innerHTML 而不是整页 HTML&#10;    try:&#10;        inner_html = driver.execute_script(&#10;            &quot;var el=document.getElementById('privacy_simple_content');return el?el.innerHTML:'';&quot;&#10;        )&#10;    except Exception as e:&#10;        print(f&quot;❌ 获取 innerHTML 失败: {e}&quot;)&#10;        return None&#10;&#10;    if not inner_html:&#10;        print(&quot;❌ privacy_simple_content.innerHTML 为空&quot;)&#10;        return None&#10;&#10;    text = html_to_formatted_text(inner_html)&#10;    if not text:&#10;        print(&quot;❌ 解析结果为空&quot;)&#10;        return None&#10;&#10;    # 尝试复制到系统剪贴板&#10;    copy_to_clipboard_macos(text)&#10;&#10;    # 同时写出到文件，方便后续 GitHub Pages 发布&#10;    try:&#10;        PRIVACY_TEXT_OUT.write_text(text, encoding=&quot;utf-8&quot;)&#10;        print(f&quot; 已写入隐私文本到文件: {PRIVACY_TEXT_OUT}&quot;)&#10;    except Exception as e:&#10;        print(f&quot;⚠️ 写入隐私文本文件失败: {e}&quot;)&#10;&#10;    driver.execute_script(&#10;        &quot;&quot;&quot;&#10;        (function(value){&#10;            let ta = document.getElementById('privacy_plain_textarea');&#10;            if(!ta){&#10;                ta = document.createElement('textarea');&#10;                ta.id = 'privacy_plain_textarea';&#10;                Object.assign(ta.style,{&#10;                    position:'fixed',right:'20px',top:'20px',width:'520px',height:'600px',&#10;                    whiteSpace:'pre-wrap',zIndex:2147483647,fontSize:'12px',padding:'8px',&#10;                    background:'#fff',border:'1px solid rgba(0,0,0,0.2)',boxShadow:'0 2px 8px rgba(0,0,0,0.15)',&#10;                    resize:'both'&#10;                });&#10;                ta.onclick=function(){this.select();};&#10;                document.body.appendChild(ta);&#10;            }&#10;            ta.value=value;&#10;            ta.style.display='block';&#10;            ta.focus();&#10;            ta.select();&#10;            let copied=false;&#10;            try{document.execCommand('copy');copied=true;}catch(e){console.warn('copy failed',e);}&#10;            if(copied){&#10;                let toast=document.getElementById('privacy_copy_toast');&#10;                if(!toast){&#10;                    toast=document.createElement('div');&#10;                    toast.id='privacy_copy_toast';&#10;                    Object.assign(toast.style,{&#10;                        position:'fixed',bottom:'30px',right:'30px',padding:'10px 18px',&#10;                        background:'rgba(0,0,0,0.8)',color:'#fff',borderRadius:'6px',&#10;                        fontSize:'14px',zIndex:2147483647,transition:'opacity 0.3s'&#10;                    });&#10;                    document.body.appendChild(toast);&#10;                }&#10;                toast.textContent='隐私文本已复制';&#10;                toast.style.opacity='1';&#10;                setTimeout(()=&gt;{toast.style.opacity='0';},2000);&#10;            }&#10;            console.log('PRIVACY_PLAIN_TEXT_START\\n'+value+'\\nPRIVACY_PLAIN_TEXT_END');&#10;        })(arguments[0]);&#10;        &quot;&quot;&quot;,&#10;        text,&#10;    )&#10;&#10;    print(&quot;------ Privacy Policy 文本开始 ------&quot;)&#10;    print(text)&#10;    print(&quot;------ Privacy Policy 文本结束 ------&quot;)&#10;    print(&quot;------ 已复制到系统剪贴板 (pbcopy) ------&quot;)&#10;&#10;    # 可选：自动发布到 GitHub Pages（依赖 googleSites.py + git push SSH）&#10;    try:&#10;        # 标题用 app_name（更友好），兜底用 Privacy Policy&#10;        page_title = (app_name or &quot;Privacy Policy&quot;).strip() or &quot;Privacy Policy&quot;&#10;        subprocess.run(&#10;            [&#10;                sys.executable,&#10;                str(Path(__file__).resolve().parent / &quot;googleSites.py&quot;),&#10;                &quot;--title&quot;,&#10;                page_title,&#10;                &quot;--content-file&quot;,&#10;                str(PRIVACY_TEXT_OUT),&#10;                &quot;--commit-message&quot;,&#10;                f&quot;Update privacy page: {page_title}&quot;,&#10;            ],&#10;            check=False,&#10;        )&#10;    except Exception as e:&#10;        print(f&quot;⚠️ 自动发布到 GitHub Pages 失败（不影响后续流程）: {e}&quot;)&#10;&#10;    return text&#10;&#10;&#10;def run_privacy_flow(driver, target_os=&quot;Android&quot;):&#10;    &quot;&quot;&quot;&#10;    执行隐私生成流程（基于 app-privacy-policy-generator）。&#10;&#10;    :param driver: selenium WebDriver 实例&#10;    :param target_os: 目标 OS 字符串，例如 &quot;iOS&quot; / &quot;Android&quot;&#10;    &quot;&quot;&quot;&#10;    global app_name, company_name, email&#10;&#10;    # 防止把 WebDriver 或其它对象当成 target_os 传进来&#10;    if not isinstance(target_os, str):&#10;        real_type = type(target_os).__name__&#10;        print(f&quot;❌ target_os 类型错误，期望字符串，实际为: {real_type}&quot;)&#10;        # 尝试回退到默认值&#10;        target_os = &quot;Android&quot;&#10;&#10;    target_os = (target_os or &quot;&quot;).strip()&#10;    if not target_os:&#10;        print(&quot;❌ target_os 为空字符串，使用默认 'Android'&quot;)&#10;        target_os = &quot;Android&quot;&#10;&#10;    driver.get(PRIVACY_GEN_URL)&#10;    try:&#10;        WebDriverWait(driver, 15).until(&#10;            EC.element_to_be_clickable((By.CLASS_NAME, &quot;start-btn&quot;))&#10;        ).click()&#10;    except Exception:&#10;        pass&#10;&#10;    # 等待 appName 输入出现&#10;    WebDriverWait(driver, 15).until(&#10;        EC.presence_of_element_located((By.ID, &quot;appName&quot;))&#10;    )&#10;    driver.find_element(By.ID, &quot;appName&quot;).clear()&#10;    driver.find_element(By.ID, &quot;appName&quot;).send_keys(app_name or &quot;&quot;)&#10;    driver.find_element(By.ID, &quot;appContact&quot;).clear()&#10;    driver.find_element(By.ID, &quot;appContact&quot;).send_keys(email or &quot;&quot;)&#10;    time.sleep(0.2)&#10;    click_next_footer(driver)&#10;&#10;    # 继续点击 Next（可能需要多步）&#10;    time.sleep(0.2)&#10;    click_next_footer(driver)&#10;    time.sleep(0.2)&#10;&#10;    # 选择 Mobile OS&#10;    radios = driver.find_elements(By.CSS_SELECTOR, 'input[type=&quot;radio&quot;]')&#10;    chosen = False&#10;    for r in radios:&#10;        try:&#10;            val = (r.get_attribute(&quot;value&quot;) or &quot;&quot;).strip()&#10;            if val and val.lower() == target_os.lower():&#10;                driver.execute_script(&#10;                    &quot;arguments[0].scrollIntoView({block:'center'});&quot;, r&#10;                )&#10;                r.click()&#10;                chosen = True&#10;                print(f&quot;✅ 已选择 Mobile OS: {target_os}&quot;)&#10;                break&#10;        except Exception:&#10;            continue&#10;    if not chosen:&#10;        # 打印页面里实际可用的 value，方便排查&#10;        available = []&#10;        for r in radios:&#10;            try:&#10;                v = (r.get_attribute(&quot;value&quot;) or &quot;&quot;).strip()&#10;                if v:&#10;                    available.append(v)&#10;            except Exception:&#10;                continue&#10;        print(&#10;            f&quot;❌ 没有找到 OS 选项: {target_os}，页面可用选项: {available or '[]'}&quot;&#10;        )&#10;&#10;    time.sleep(0.2)&#10;    click_next_footer(driver)&#10;    time.sleep(0.2)&#10;&#10;    # 填写 Company Name&#10;    dev_input = driver.find_elements(By.ID, &quot;devName&quot;)&#10;    if dev_input:&#10;        el = dev_input[0]&#10;        el.clear()&#10;        el.send_keys(company_name or &quot;&quot;)&#10;        print(&quot;✅ 已填写 Company Name&quot;)&#10;    time.sleep(0.2)&#10;    click_next_footer(driver)&#10;    time.sleep(0.2)&#10;&#10;    # 勾选第三方服务（示例 id 列表，可以根据页面实际 id 调整）&#10;    third_party_ids = [&#10;        &quot;list-switch-Google Analytics for Firebase&quot;,&#10;        &quot;list-switch-Firebase Crashlytics&quot;,&#10;        &quot;list-switch-Adjust&quot;,&#10;    ]&#10;    for cid in third_party_ids:&#10;        ensure_check_checkbox(driver, cid, timeout=6)&#10;        time.sleep(0.2)&#10;&#10;    # Next -&gt; Privacy Policy&#10;    time.sleep(0.2)&#10;    click_next_footer(driver)&#10;    time.sleep(0.2)&#10;&#10;    # 点击 Privacy Policy 按钮&#10;    footer_links = driver.find_elements(By.CLASS_NAME, &quot;card-footer-item&quot;)&#10;    clicked_priv = False&#10;    for link in footer_links:&#10;        try:&#10;            if link.text.strip().lower() == &quot;privacy policy&quot;:&#10;                link.click()&#10;                clicked_priv = True&#10;                print(&quot;✅ 已点击 Privacy Policy&quot;)&#10;                break&#10;        except Exception:&#10;            continue&#10;    if not clicked_priv:&#10;        print(&quot;❌ 没有找到 Privacy Policy 按钮&quot;)&#10;    extract_and_show_privacy_text(driver)&#10;    # return True&#10;&#10;&#10;# def create_driver(headless=False, user_data_dir=None, profile_dir=None):&#10;#     opts = webdriver.ChromeOptions()&#10;#     opts.add_argument('--start-maximized')&#10;#     if headless:&#10;#         opts.add_argument('--headless=new')&#10;#     if user_data_dir:&#10;#         opts.add_argument(f'--user-data-dir={user_data_dir}')&#10;#     if profile_dir:&#10;#         opts.add_argument(f'--profile-directory={profile_dir}')&#10;#     return webdriver.Chrome(options=opts)&#10;&#10;from selenium import webdriver&#10;from selenium.webdriver.chrome.service import Service&#10;from webdriver_manager.chrome import ChromeDriverManager&#10;&#10;def create_driver(headless=False, user_data_dir=None, profile_dir=None, chrome_binary=None):&#10;    opts = webdriver.ChromeOptions()&#10;    opts.add_argument('--start-maximized')&#10;    if headless:&#10;        opts.add_argument('--headless=new')&#10;    if user_data_dir:&#10;        opts.add_argument(f'--user-data-dir={user_data_dir}')&#10;    if profile_dir:&#10;        opts.add_argument(f'--profile-directory={profile_dir}')&#10;    if chrome_binary:&#10;        opts.binary_location = chrome_binary  # 可选：显式指定 Chrome 可执行文件路径&#10;    service = Service(ChromeDriverManager().install())  # 自动下载并使用匹配的 chromedriver&#10;    return webdriver.Chrome(service=service, options=opts)&#10;&#10;&#10;def find_and_collect_by_target_value(json_obj, target_value=None):&#10;    &quot;&quot;&quot;&#10;    按订单号筛选并在找到时把 app_name 写入全局变量 app_name，继续返回结果列表。&#10;    &quot;&quot;&quot;&#10;    # 顶层函数本身不直接读写 app_name，只在内部嵌套函数里操作&#10;&#10;    if not target_value:&#10;        print(&quot;❌ 需要提供 target_value (订单编号)，例如 'IGT1185'&quot;)&#10;        return []&#10;&#10;    results = []&#10;    target_str = str(target_value).strip().lower()&#10;&#10;    def _search(obj):&#10;        # 这里显式声明使用全局 app_name，避免 UnboundLocalError&#10;        global app_name&#10;&#10;        if isinstance(obj, dict):&#10;            fld_order = obj.get(&quot;fldxQWjXD7&quot;)&#10;            if isinstance(fld_order, dict):&#10;                val = fld_order.get(&quot;value&quot;)&#10;                if isinstance(val, list):&#10;                    for entry in val:&#10;                        if isinstance(entry, dict):&#10;                            text = (entry.get(&quot;text&quot;) or &quot;&quot;).strip()&#10;                            if text.lower() == target_str:&#10;                                # 提取 app_name（来自 fldaShB3Gb 的第一个 value 的 text）&#10;                                found_app_name = None&#10;                                flda = obj.get(&quot;fldaShB3Gb&quot;)&#10;                                if isinstance(flda, dict):&#10;                                    fval = flda.get(&quot;value&quot;)&#10;                                    if isinstance(fval, list) and fval:&#10;                                        first = fval[0]&#10;                                        if isinstance(first, dict):&#10;                                            found_app_name = (first.get(&quot;text&quot;) or &quot;&quot;).strip() or None&#10;&#10;                                # 尝试在 fldnLglcRi 中写入 app_name 并返回其第一个 value&#10;                                fldn = obj.get(&quot;fldnLglcRi&quot;)&#10;                                if isinstance(fldn, dict):&#10;                                    v = fldn.get(&quot;value&quot;)&#10;                                    if isinstance(v, list) and v:&#10;                                        first_item = v[0]&#10;                                        if isinstance(first_item, dict):&#10;                                            if found_app_name:&#10;                                                first_item[&quot;app_name&quot;] = found_app_name&#10;                                            results.append(first_item)&#10;                                        else:&#10;                                            new_item = {&quot;value&quot;: first_item}&#10;                                            if found_app_name:&#10;                                                new_item[&quot;app_name&quot;] = found_app_name&#10;                                            results.append(new_item)&#10;                                    else:&#10;                                        new_item = {}&#10;                                        if found_app_name:&#10;                                            new_item[&quot;app_name&quot;] = found_app_name&#10;                                        results.append(new_item)&#10;                                else:&#10;                                    if found_app_name:&#10;                                        results.append({&quot;app_name&quot;: found_app_name})&#10;                                    else:&#10;                                        results.append(obj)&#10;&#10;                                # 无论之前是否有值，直接把找到的 app_name 赋给全局变量&#10;                                if found_app_name:&#10;                                    app_name = found_app_name&#10;                                    print(f&quot; 已设置全局 app_name = `{app_name}`&quot;)&#10;&#10;                                break&#10;&#10;            # 继续递归查找子节点&#10;            for v in obj.values():&#10;                _search(v)&#10;&#10;        elif isinstance(obj, list):&#10;            for item in obj:&#10;                _search(item)&#10;&#10;    _search(json_obj)&#10;    return results&#10;&#10;&#10;def extract_vps_array_from_doc22(doc_data, cookies_str):&#10;    global company_name, email&#10;    print(&quot; 提取页面中首个有效的 @gmail.com 邮箱...&quot;)&#10;    results = []&#10;    seen_urls = set()&#10;&#10;    headers = {&#10;        &quot;Cookie&quot;: cookies_str or &quot;&quot;,&#10;        &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/123.0 Safari/537.36&quot;,&#10;    }&#10;&#10;    email_re = re.compile(r'(?&lt;![A-Za-z0-9._%+\-])([A-Za-z0-9._%+\-]+@gmail\.com)\b', re.I)&#10;&#10;    def _clean_gmail_emails(raw_text):&#10;        found = email_re.findall(raw_text or &quot;&quot;)&#10;        unique = []&#10;        seen = set()&#10;        for e in found:&#10;            ne = e.strip().lower()&#10;            if ne and ne not in seen:&#10;                seen.add(ne)&#10;                unique.append(ne)&#10;        final = []&#10;        sset = set(unique)&#10;        for e in unique:&#10;            if len(e) &gt; 1 and e[1:] in sset and len(e[0]) == 1:&#10;                continue&#10;            final.append(e)&#10;        return final&#10;&#10;    for item in doc_data:&#10;        url = item.get(&quot;link&quot;)&#10;        text = item.get(&quot;text&quot;, &quot;&quot;)&#10;        if not url and not text:&#10;            continue&#10;        if url in seen_urls:&#10;            continue&#10;&#10;        try:&#10;            response = requests.get(url, headers=headers, timeout=15)&#10;            if response.status_code != 200:&#10;                print(f&quot;❌ 请求失败: {url}, 状态码: {response.status_code}&quot;)&#10;                continue&#10;&#10;            page_content = html.unescape(response.text or &quot;&quot;)&#10;            emails = _clean_gmail_emails(page_content)&#10;            primary = emails[0] if emails else &quot;&quot;&#10;&#10;            # 首次发现时，设置全局 company_name 和 email（如果尚未设置）&#10;            if not company_name:&#10;                t = (text or &quot;&quot;).strip()&#10;                m = re.search(r'-(.+)$', t)&#10;                if m:&#10;                    company_name = m.group(1).strip()&#10;                else:&#10;                    parts = t.split(None, 1)&#10;                    company_name = parts[1].strip() if len(parts) &gt; 1 else (t or &quot;&quot;)&#10;&#10;            if primary and not email:&#10;                email = primary.strip().lower()&#10;&#10;            results.append(&#10;                {&#10;                    &quot;text&quot;: text,&#10;                    &quot;url&quot;: url,&#10;                    &quot;email&quot;: primary,&#10;                }&#10;            )&#10;            seen_urls.add(url)&#10;&#10;        except Exception as e:&#10;            print(f&quot;❌ 解析失败: {url}, 错误: {e}&quot;)&#10;&#10;        # 如果全局信息都已填充，可以选择提前退出以加快速度&#10;        if company_name and email:&#10;            break&#10;&#10;    # 按 text 中的数字排序（保持原有行为）&#10;    def _extract_number(t):&#10;        m = re.search(r&quot;(\d+)&quot;, (t or &quot;&quot;))&#10;        return int(m.group(1)) if m else 0&#10;&#10;    results.sort(key=lambda x: _extract_number(x.get(&quot;text&quot;)))&#10;&#10;    for item in results:&#10;        print(f&quot;{item.get('text')}&quot;)&#10;        if item.get('email'):&#10;            print(f&quot;  邮箱: {item.get('email')}&quot;)&#10;        else:&#10;            print(&quot;  邮箱: 未发现 @gmail.com 地址&quot;)&#10;        print(&quot;-&quot; * 50)&#10;&#10;    print(f&quot;✅ 总数量: {len(results)}&quot;)&#10;    return results&#10;&#10;&#10;def save_to_json(data, filename=&quot;none.json&quot;):&#10;    Path(filename).write_text(json.dumps(data, ensure_ascii=False, indent=2))&#10;    # print(f&quot;✅ 已保存 {len(data)} 条结果到 {filename}&quot;)&#10;&#10;&#10;import argparse&#10;&#10;if __name__ == &quot;__main__&quot;:&#10;    parser = argparse.ArgumentParser()&#10;    parser.add_argument('id', nargs='?', help='表格中查找的编号，例如 IGT1128')&#10;    args = parser.parse_args()&#10;&#10;    # 交互获取 id（若未通过命令行提供）&#10;    if not args.id:&#10;        try:&#10;            args.id = input(&quot;请输入编号（例如 IGT1128）：&quot;).strip()&#10;        except (EOFError, KeyboardInterrupt):&#10;            args.id = None&#10;&#10;    if not args.id:&#10;        print(&quot;❌ 未提供编号，脚本将退出。\n示例用法：python privacys.py IGT1128 --scan&quot;)&#10;        sys.exit(2)&#10;&#10;    try:&#10;        records, cookies_str = get_gzip_json_from_api()&#10;        if not records:&#10;            print(&quot;❌ 未能获取 records，脚本退出&quot;)&#10;            sys.exit(1)&#10;&#10;        available_records = find_and_collect_by_target_value(records, target_value=args.id)&#10;        vps_result = extract_vps_array_from_doc22(available_records, cookies_str)&#10;&#10;        driver = create_driver()&#10;        run_privacy_flow(driver=driver, target_os=&quot;Android&quot;)&#10;    finally:&#10;        if driver is not None:&#10;            try:&#10;                driver.quit()&#10;            except Exception:&#10;                pass" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>